DVAR $hFile
DVAR $cCheck
DVAR $press
DVAR $length
DVAR $lame
DVAR $comport


DVAR $found, $floor $delta $deltafast $Ax $Ay $Bx $By $Cx $Cy $Dx $Dy $Px $Py $posA $posB $posC $posD $posZ $fastfeed $midfeed $slowfeed $Astart $Bstart $Cstart $Dstart $Pstart $comma1 $comma2 $comma1plus $comma2plus
DVAR $Ax_dif $Ay_dif $Bx_dif $By_dif $Cx_dif $Cy_dif $Dx_dif $Dy_dif $Px_dif $Py_dif
DVAR $nozzle $nozzleA $nozzleB $nozzleC $nozzleD $profilometerRod $xStart $yStart $zStart 
DVAR $zMeasureA $zMeasureB $zMeasureC $zMeasureD $Az_dif $Bz_dif $Cz_dif $Dz_dif $xOffset $yOffset
DVAR $zA $zB $zC $zD $check
DVAR $zSweepRange $zSweepStep $numsteps $tempdistance $zDwell $count $z_dif $z_past $z_num $indicator $step $start $x_dist
DVAR $align_save
FILECLOSE 

$floor = -72
$deltafast = 1
$delta = 0.1
$fastfeed = 40
$midfeed = 10
$slowfeed = 2
$Astart = -15
$Bstart = -15
$Cstart = -15
$Dstart = -15
$Pstart = -15
$nozzleA=1
$nozzleB=2
$nozzleC=3
$nozzleD=4
$profilometerRod = 5

$Ax = 586.075
$Ay = 367.8285
$Bx = 482.075
$By = 367.8285
$Cx = 378.075
$Cy = 367.8285
$Dx = 299.075
$Dy = 367.8285
$Px = 148
$Py = 345

$DO0.0=0
$DO1.0=0
$DO2.0=0
$DO3.0=0
Primary ; sets primary units mm and s
G65 F2000; accel speed mm/s^2
G66 F2000;accel speed mm/s^2
ENABLE X Y A B C D U
POSOFFSET CLEAR X Y U A B C D
G91 ;start off in relative mode

G90
G1 X0.000000 Y-0.250000
G91
sign is 1
G17
G2 Y0.5 X0 R0.25
G17
sign is -1
G17
G2 Y-1.0 X0 R0.5
G17
sign is 1
G17
G2 Y1.5 X0 R0.75
G17
sign is -1
G17
G2 Y-2.0 X0 R1.0
G17
sign is 1
G17
G2 Y2.5 X0 R1.25
G17
sign is -1
G17
G2 Y-3.0 X0 R1.5
G17
sign is 1
G17
G2 Y3.5 X0 R1.75
G17
sign is -1
G17
G2 Y-4.0 X0 R2.0
G17
sign is 1
G17
G2 Y4.5 X0 R2.25
G17
sign is -1
G17
G2 Y-5.0 X0 R2.5
G17
sign is 1
G17
G2 Y5.5 X0 R2.75
G17
sign is -1
G17
G2 Y-6.0 X0 R3.0
G17
sign is 1
G17
G2 Y6.5 X0 R3.25
G17
sign is -1
G17
G2 Y-7.0 X0 R3.5
G17
sign is 1
G17
G2 Y7.5 X0 R3.75
G17
sign is -1
G17
G2 Y-8.0 X0 R4.0
G17
sign is 1
G17
G2 Y8.5 X0 R4.25
G17
sign is -1
G17
G2 Y-9.0 X0 R4.5
G17
sign is 1
G17
G2 Y9.5 X0 R4.75
G17
sign is -1
G17
G2 Y-10.0 X0 R5.0
G17
sign is 1
G17
G2 Y10.5 X0 R5.25
G17
sign is -1
G17
G2 Y-11.0 X0 R5.5
G17
sign is 1
G17
G2 Y11.5 X0 R5.75
G17
sign is -1
G17
G2 Y-12.0 X0 R6.0
G17
sign is 1
G17
G2 Y12.5 X0 R6.25
G17
sign is -1
G17
G2 Y-13.0 X0 R6.5
G17
sign is 1
G17
G2 Y13.5 X0 R6.75
G17
sign is -1
G17
G2 Y-14.0 X0 R7.0
G17
sign is 1
G17
G2 Y14.5 X0 R7.25
G17
sign is -1
G17
G2 Y-15.0 X0 R7.5
G17
sign is 1
G17
G2 Y15.5 X0 R7.75
G17
sign is -1
G17
G2 Y-16.0 X0 R8.0
G17
sign is 1
G17
G2 Y16.5 X0 R8.25
G17
sign is -1
G17
G2 Y-17.0 X0 R8.5
G17
sign is 1
G17
G2 Y17.5 X0 R8.75
G17
sign is -1
G17
G2 Y-18.0 X0 R9.0
G17
sign is 1
G17
G2 Y18.5 X0 R9.25
G17
sign is -1
G17
G2 Y-19.0 X0 R9.5
G17
sign is 1
G17
G2 Y19.5 X0 R9.75
G17
sign is -1
G17
G2 Y-20.0 X0 R10.0
G17
sign is 1
G17
G2 Y20.5 X0 R10.25
G17
sign is -1
G17
G2 Y-21.0 X0 R10.5
G17
sign is 1
G17
G2 Y21.5 X0 R10.75
G17
sign is -1
G17
G2 Y-22.0 X0 R11.0
G17
sign is 1
G17
G2 Y22.5 X0 R11.25
G17
sign is -1
G17
G2 Y-23.0 X0 R11.5
G17
sign is 1
G17
G2 Y23.5 X0 R11.75
G17
sign is -1
G17
G2 Y-24.0 X0 R12.0
G17
sign is 1
G17
G2 Y24.5 X0 R12.25
G17
sign is -1
G17
G2 Y-25.0 X0 R12.5
G17
sign is 1
G17
G2 Y25.5 X0 R12.75
G17
sign is -1
G17
G2 Y-26.0 X0 R13.0
G17
sign is 1
G17
G2 Y26.5 X0 R13.25
G17
sign is -1
G17
G2 Y-27.0 X0 R13.5
G17
sign is 1
G17
G2 Y27.5 X0 R13.75
G17
sign is -1
G17
G2 Y-28.0 X0 R14.0
G17
sign is 1
G17
G2 Y28.5 X0 R14.25
G17
sign is -1
G17
G2 Y-29.0 X0 R14.5
G17
sign is 1
G17
G2 Y29.5 X0 R14.75
G17
sign is -1
G17
G2 Y-30.0 X0 R15.0
G17
sign is 1
G17
G2 Y30.5 X0 R15.25
G17
sign is -1
G17
G2 Y-31.0 X0 R15.5
G17
sign is 1
G17
G2 Y31.5 X0 R15.75
G17
sign is -1
G17
G2 Y-32.0 X0 R16.0
G17
sign is 1
G17
G2 Y32.5 X0 R16.25
G17
sign is -1
G17
G2 Y-33.0 X0 R16.5
G17
sign is 1
G17
G2 Y33.5 X0 R16.75
G17
sign is -1
G17
G2 Y-34.0 X0 R17.0
G17
sign is 1
G17
G2 Y34.5 X0 R17.25
G17
sign is -1
G17
G2 Y-35.0 X0 R17.5
G17
sign is 1
G17
G2 Y35.5 X0 R17.75
G17
sign is -1
G17
G2 Y-36.0 X0 R18.0
G17
sign is 1
G17
G2 Y36.5 X0 R18.25
G17
sign is -1
G17
G2 Y-37.0 X0 R18.5
G17
sign is 1
G17
G2 Y37.5 X0 R18.75
G17
sign is -1
G17
G2 Y-38.0 X0 R19.0
G17
sign is 1
G17
G2 Y38.5 X0 R19.25
G17
sign is -1
G17
G2 Y-39.0 X0 R19.5
G17
sign is 1
G17
G2 Y39.5 X0 R19.75
G17
sign is -1
G17
G2 Y-40.0 X0 R20.0
G17
sign is 1
G17
G2 Y40.5 X0 R20.25
G17
sign is -1
G17
G2 Y-41.0 X0 R20.5
G17
sign is 1
G17
G2 Y41.5 X0 R20.75
G17
sign is -1
G17
G2 Y-42.0 X0 R21.0
G17
sign is 1
G17
G2 Y42.5 X0 R21.25
G17
sign is -1
G17
G2 Y-43.0 X0 R21.5
G17
sign is 1
G17
G2 Y43.5 X0 R21.75
G17
sign is -1
G17
G2 Y-44.0 X0 R22.0
G17
sign is 1
G17
G2 Y44.5 X0 R22.25
G17
sign is -1
G17
G2 Y-45.0 X0 R22.5
G17
sign is 1
G17
G2 Y45.5 X0 R22.75
G17
sign is -1
G17
G2 Y-46.0 X0 R23.0
G17
sign is 1
G17
G2 Y46.5 X0 R23.25
G17
sign is -1
G17
G2 Y-47.0 X0 R23.5
G17
sign is 1
G17
G2 Y47.5 X0 R23.75
G17
sign is -1
G17
G2 Y-48.0 X0 R24.0
G17
sign is 1
G17
G2 Y48.5 X0 R24.25
G17
sign is -1
G17
G2 Y-49.0 X0 R24.5
G17
sign is 1
G17
G2 Y49.5 X0 R24.75
G17
sign is -1
G17
G2 Y-50.0 X0 R25.0
G17
sign is 1
G17
G2 Y50.5 X0 R25.25
G17
sign is -1
G17
G2 Y-51.0 X0 R25.5
G17
sign is 1
G17
G2 Y51.5 X0 R25.75
G17
sign is -1
G17
G2 Y-52.0 X0 R26.0
G17
sign is 1
G17
G2 Y52.5 X0 R26.25
G17
sign is -1
G17
G2 Y-53.0 X0 R26.5
G17
sign is 1
G17
G2 Y53.5 X0 R26.75
G17
sign is -1
G17
G2 Y-54.0 X0 R27.0
G17
sign is 1
G17
G2 Y54.5 X0 R27.25
G17
sign is -1
G17
G2 Y-55.0 X0 R27.5
G17
sign is 1
G17
G2 Y55.5 X0 R27.75
G17
sign is -1
G17
G2 Y-56.0 X0 R28.0
G17
sign is 1
G17
G2 Y56.5 X0 R28.25
G17
sign is -1
G17
G2 Y-57.0 X0 R28.5
G17
sign is 1
G17
G2 Y57.5 X0 R28.75
G17
sign is -1
G17
G2 Y-58.0 X0 R29.0
G17
sign is 1
G17
G2 Y58.5 X0 R29.25
G17
sign is -1
G17
G2 Y-59.0 X0 R29.5
G17
sign is 1
G17
G2 Y59.5 X0 R29.75
G17
sign is -1
G17
G2 Y-60.0 X0 R30.0
G17
;#################################### Code ##########################################

M2

;##########Functions############;
DFS setPress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000
                             
        $press = $Q * 10.0                             
        $strtask2 = DBLTOSTR( $press , 0 )  
      
      
        $length = STRLEN( $strtask2 )      
        WHILE $length < 4.0
                $strtask2 = "0" + $strtask2    
                $length = STRLEN( $strtask2 ) 
        ENDWHILE


        $strtask2 = "08PS  " + $strtask2
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 6) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 7) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 8) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 9)  
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
            
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile


ENDDFS


DFS togglePress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000


        $strtask2 = "04DI  "
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
                  
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile
        G4 P0.15

ENDDFS

DFS alignNozzle

	$zStart = $Q
	$delta = $R
	$nozzle = $L
	$floor = $I
	$deltafast = $J

	;#$Ax = 483
	;#$Ay = 317
	;#$Bx = 379
	;#$By = 317
	;#$Cx = 275
	;#$Cy = 317
	;#$Dx = 196
	;#$Dy = 317
	;#$Px = 148
	;#$Py = 345
	
	$Ax = 606.662
	$Ay = 352.920
	$Bx = 502.662
	$By = 352.920
	$Cx = 398.662
	$Cy = 352.920
	$Dx = 319.662
	$Dy = 352.920
	$Px = 148
	$Py = 345
	
	$comport = FILEOPEN "COM8", 2
	COMMINIT $comport, "baud=115200 parity=N data=8 stop=1" ; Initialize comport
	COMMSETTIMEOUT $comport, -1, 0, 0
	
	G90
	G1 A-0.5 B-0.5 C-0.5 D-0.5 F$fastfeed
	IF $nozzle = 1
		$xStart = $Ax
		$yStart = $Ay
		G1 X$xStart Y$yStart
		G1 A$zStart
	ELSE IF $nozzle = 2
		$xStart = $Bx
		$yStart = $By
		G1 X$xStart Y$yStart
		G1 B$zStart
	ELSE IF $nozzle = 3
		$xStart = $Cx
		$yStart = $Cy
		G1 X$xStart Y$yStart
		G1 C$zStart
	ELSE IF $nozzle = 4
		$xStart = $Dx
		$yStart = $Dy
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE IF $nozzle = 5
		$xStart = $Px
		$yStart = $Py
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE 
		G1 A-1 B-1 C-1 D-1
	ENDIF
	G91


	$found = 0
	WHILE $found != -1
	
		FILEWRITE $comport "M0,0"
		FILEREAD $comport 0 $strglob0	
		$found = STRFIND($strglob0, "--", 1)
		IF $nozzle == 1
			$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==2
			$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==3
			$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==4
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==5
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ENDIF
		
		IF ($posZ - $deltafast) < $floor
			$found = -1
		ELSE
			IF $nozzle == 1
				G1 A-$deltafast F$midfeed
				ELSEIF $nozzle == 2
				G1 B-$deltafast F$midfeed
				ELSEIF $nozzle == 3
				G1 C-$deltafast F$midfeed
				ELSEIF $nozzle == 4
				G1 D-$deltafast F$midfeed
				ELSEIF $nozzle == 5
				G1 D-$deltafast F$midfeed
				ELSE
				MSGDISPLAY 1 "something is messed up"
			ENDIF
		ENDIF
	ENDWHILE

; move up slightly and redo it again slowly
IF $nozzle == 1
			G1 A3.5 F$fastfeed
			ELSEIF $nozzle == 2
			G1 B3.5 F$fastfeed
			ELSEIF $nozzle == 3
			G1 C3.5 F$fastfeed
			ELSEIF $nozzle == 4
			G1 D3.5 F$fastfeed
			ELSEIF $nozzle == 5
			G1 D3.5 F$fastfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF



	$found = 0
WHILE $found != -1

	FILEWRITE $comport "M0,0"
	FILEREAD $comport 0 $strglob0	
	$found = STRFIND($strglob0, "--", 1)
	IF $nozzle ==1
		$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==2
		$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==3
		$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==4
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==5
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
	ENDIF
	
	IF ($posZ - $deltafast) < $floor
		$found = -1
	ELSE
		IF $nozzle == 1
			G1 A-$delta F$slowfeed
			ELSEIF $nozzle == 2
			G1 B-$delta F$slowfeed
			ELSEIF $nozzle == 3
			G1 C-$delta F$slowfeed
			ELSEIF $nozzle == 4
			G1 D-$delta F$slowfeed
			ELSEIF $nozzle == 5
			G1 D-$delta F$slowfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
		ENDIF
	ENDIF
ENDWHILE

IF $nozzle == 1
			G1 A-0.4 F$midfeed
			ELSEIF $nozzle == 2
			G1 B-0.4 F$midfeed
			ELSEIF $nozzle == 3
			G1 C-0.4 F$midfeed
			ELSEIF $nozzle == 4
			G1 D-0.4 F$midfeed
			ELSEIF $nozzle == 5
			G1 D-0.4 F$midfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF

;Dwell to get accurate Reading
DWELL 0.75

; read from keyance
FILEWRITE $comport "M0,0"
FILEREAD $comport 0 $strglob0

; Assign Reading To Variables

	$comma1 = STRFIND($strglob0, ",", 1)
	$comma1plus=$comma1+1
	$STRGLOB1 = STRMID ($STRGLOB0, $comma1plus, 40)
	$comma2 = STRFIND($strglob1, ",", 1)
	$comma2 = $comma2 + $comma1
	$comma2plus = $comma2+2
	$STRGLOB2 = STRMID ($STRGLOB0, $comma1plus, $comma2)
	$STRGLOB3 = STRMID ($STRGLOB0, $comma2plus, 40)

		IF $nozzle = 1
			$Ax_dif = STRTODBL($STRGLOB2)
			$Ay_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 2
			$Bx_dif = STRTODBL($STRGLOB2)
			$By_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 3
			$Cx_dif = STRTODBL($STRGLOB2)
			$Cy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 4
			$Dx_dif = STRTODBL($STRGLOB2)
			$Dy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 5
			$Px_dif = STRTODBL($STRGLOB2)
			$Py_dif = STRTODBL($STRGLOB3)
		ENDIF

	G90
	G1 A-1 B-1 C-1 D-1 F$fastfeed
	G91
	
	

	FILECLOSE $comport
ENDDFS



DFS alignZeroNozzle

	$zStart = $Q
	$delta = $R
	$nozzle = $L
	$floor = $I
	$deltafast = $J

        ;#$Ax = 483
	;#$Ay = 317
	;#$Bx = 379
	;#$By = 317
	;#$Cx = 275
	;#$Cy = 317
	;#$Dx = 196
	;#$Dy = 317
	;#$Px = 148
	;#$Py = 345
	
	$Ax = 586.075
	$Ay = 367.8285
	$Bx = 482.075
	$By = 367.8285
	$Cx = 378.075
	$Cy = 367.8285
	$Dx = 299.075
	$Dy = 367.8285
	$Px = 148
	$Py = 345
	
	$xOffset = 0.7
	$yOffset = -0.7
	$DO7.0=0
	$comport = FILEOPEN "COM8", 2
	COMMINIT $comport, "baud=115200 parity=N data=8 stop=1" ; Initialize comport
	COMMSETTIMEOUT $comport, -1, 0, 0
	
	
	FILEWRITE $comport "PW,3" ; Select Program #3
	FILEREAD $comport 0 $strglob1

	
	G90
	G1 A-0.5 B-0.5 C-0.5 D-0.5 F$fastfeed
	IF $nozzle = 1
		$xStart = $Ax
		$yStart = $Ay
		G1 X$xStart Y$yStart
		G1 A$zStart
	ELSE IF $nozzle = 2
		$xStart = $Bx
		$yStart = $By
		G1 X$xStart Y$yStart
		G1 B$zStart
	ELSE IF $nozzle = 3
		$xStart = $Cx
		$yStart = $Cy
		G1 X$xStart Y$yStart
		G1 C$zStart
	ELSE IF $nozzle = 4
		$xStart = $Dx
		$yStart = $Dy
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE IF $nozzle = 5
		$xStart = $Px
		$yStart = $Py
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE 
		G1 A-1 B-1 C-1 D-1
	ENDIF
	G91


	$found = 0
	WHILE $found != -1
	
		FILEWRITE $comport "M0,0"
		FILEREAD $comport 0 $strglob0	
		
		$found = STRFIND($strglob0, "--", 1)
		IF $nozzle == 1
			$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==2
			$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==3
			$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==4
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==5
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ENDIF
		
		
		IF ($posZ - $deltafast) < $floor
			$found = -1
		ELSE
			IF $nozzle == 1
				G1 A-$deltafast F$midfeed
				ELSEIF $nozzle == 2
				G1 B-$deltafast F$midfeed
				ELSEIF $nozzle == 3
				G1 C-$deltafast F$midfeed
				ELSEIF $nozzle == 4
				G1 D-$deltafast F$midfeed
				ELSEIF $nozzle == 5
				G1 D-$deltafast F$midfeed
				ELSE
				MSGDISPLAY 1 "something is messed up"
			ENDIF
		ENDIF
		
	ENDWHILE

; move up slightly and redo it again slowly
IF $nozzle == 1
			G1 A3.5 F$fastfeed
			ELSEIF $nozzle == 2
			G1 B3.5 F$fastfeed
			ELSEIF $nozzle == 3
			G1 C3.5 F$fastfeed
			ELSEIF $nozzle == 4
			G1 D3.5 F$fastfeed
			ELSEIF $nozzle == 5
			G1 D3.5 F$fastfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF



	$found = 0
WHILE $found != -1

	FILEWRITE $comport "M0,0"
	FILEREAD $comport 0 $strglob0	
	$found = STRFIND($strglob0, "--", 1)
	IF $nozzle ==1
		$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==2
		$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==3
		$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==4
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==5
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
	ENDIF
	
	IF ($posZ - $deltafast) < $floor
		$found = -1
	ELSE
		IF $nozzle == 1
			G1 A-$delta F$slowfeed
			ELSEIF $nozzle == 2
			G1 B-$delta F$slowfeed
			ELSEIF $nozzle == 3
			G1 C-$delta F$slowfeed
			ELSEIF $nozzle == 4
			G1 D-$delta F$slowfeed
			ELSEIF $nozzle == 5
			G1 D-$delta F$slowfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
		ENDIF
	ENDIF
ENDWHILE

IF $nozzle == 1
			G1 A-0.4 F$midfeed
			ELSEIF $nozzle == 2
			G1 B-0.4 F$midfeed
			ELSEIF $nozzle == 3
			G1 C-0.4 F$midfeed
			ELSEIF $nozzle == 4
			G1 D-0.4 F$midfeed
			ELSEIF $nozzle == 5
			G1 D-0.4 F$midfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF

;Dwell to get accurate Reading
DWELL 0.75

; read from keyance
FILEWRITE $comport "M0,0"
FILEREAD $comport 0 $strglob0

; Assign Reading To Variables

	$comma1 = STRFIND($strglob0, ",", 1)
	$comma1plus=$comma1+1
	$STRGLOB1 = STRMID ($STRGLOB0, $comma1plus, 40)
	$comma2 = STRFIND($strglob1, ",", 1)
	$comma2 = $comma2 + $comma1
	$comma2plus = $comma2+2
	$STRGLOB2 = STRMID ($STRGLOB0, $comma1plus, $comma2)
	$STRGLOB3 = STRMID ($STRGLOB0, $comma2plus, 40)

		IF $nozzle = 1
			$Ax_dif = STRTODBL($STRGLOB2)
			$Ay_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 2
			$Bx_dif = STRTODBL($STRGLOB2)
			$By_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 3
			$Cx_dif = STRTODBL($STRGLOB2)
			$Cy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 4
			$Dx_dif = STRTODBL($STRGLOB2)
			$Dy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 5
			$Px_dif = STRTODBL($STRGLOB2)
			$Py_dif = STRTODBL($STRGLOB3)
		ENDIF


;switch keyence programs
$DO7.0=1
FILEWRITE $comport "PW,4" ; Select Program #4
FILEREAD $comport 0 $strglob1

; Attain zero value
        IF $nozzle = 1
			G91
			G1 X-$Ax_dif Y-$Ay_dif F5
			G1 X$xOffset Y$yOffset
			$zMeasureA = AXISSTATUS(A, DATAITEM_PositionFeedback)
			DWELL 3
			CALL zHold Q3 R0.075 L0.25
	                $Az_dif = $z_dif
	                MSGDISPLAY 1 "Az_dif: " + $Az_dif
			MSGDISPLAY 1 "zMeasureA: " + $zMeasureA
			
			ELSEIF $nozzle == 2
			G91
			G1 X-$Bx_dif Y-$By_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureB = AXISSTATUS(B, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Bz_dif = $z_dif
	                MSGDISPLAY 1 "Bz_dif: " + $Bz_dif
			MSGDISPLAY 1 "zMeasureB: " + $zMeasureB
	                
			ELSEIF $nozzle == 3
			G91
			G1 X-$Cx_dif Y-$Cy_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureC = AXISSTATUS(C, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Cz_dif = $z_dif
	                MSGDISPLAY 1 "Cz_dif: " + $Cz_dif
			MSGDISPLAY 1 "zMeasureC: " + $zMeasureC
	                
			ELSEIF $nozzle == 4
			G91
			G1 X-$Dx_dif Y-$Dy_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureD = AXISSTATUS(D, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Dz_dif = $z_dif
	                MSGDISPLAY 1 "Dz_dif: " + $Dz_dif
			MSGDISPLAY 1 "zMeasureD: " + $zMeasureD
		ENDIF

$DO7.0=0
FILEWRITE $comport "PW,3" ; Select Program #3
FILEREAD $comport 0 $strglob1
	G90
	G1 A-1 B-1 C-1 D-1 F$fastfeed
	G91
	
	

	FILECLOSE $comport
ENDDFS

DFS zHold
    $zSweepRange = $Q
    $zSweepStep = $R
    $zDwell = $L
    $start = (($zSweepRange/2)/1.414213)
    $x_dist = (($zSweepRange)/1.414213)
    
    G91
    G1 X-($start) Y$start F2

    FILEWRITE $comport "U1"
    FILEREAD $comport 0 $strglob0
    G1 X$x_dist Y-$x_dist F0.5
    FILEWRITE $comport "L1,0"
    FILEREAD $comport 0 $strglob0
    $STRGLOB1 = STRMID ($STRGLOB0, 4, -1)
    $z_dif = STRTODBL($STRGLOB1)

ENDDFS
        


DFS zSweep
$zSweepRange = $Q
$zSweepStep = $R
$zDwell = $L


$indicator = 0
$z_num = 0
$numsteps = ($zSweepRange/$zSweepStep)
$start = (($zSweepRange/2)/1.414213)
$step = $zSweepStep/1.414213
$z_dif=6
$count = 0
G91
G1 X-($start) Y$start F2

WHILE $count<$numsteps
	
	
	Dwell $zDwell
	FILEWRITE $comport "M2,0"
	FILEREAD $comport 0 $strglob0
	$STRGLOB1 = STRMID ($STRGLOB0, 4, -1)
	$tempdistance = STRTODBL($STRGLOB1)
	IF $tempdistance < $z_dif
	        $z_dif=$tempdistance
	        $z_past = $z_dif + 1
		;$indicator = 1
                MSGDISPLAY 1 "zdif recorded: " + $z_dif
	ENDIF
	IF $indicator = 1
	       IF $tempdistance > $z_past
	           $z_num = $z_num + 1
	       ELSE 
	           $z_num = 0
	       ENDIF
	ENDIF
	IF $z_num = 5
	   GOTO quit_loop
	ENDIF
	$count = $count + 1
	G1 X($step) Y-$step F2
ENDWHILE
:quit_loop
ENDDFS

DFS save_value

    $nozzle = $Q
IF $nozzle = 1
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_1.txt", 0
    FILEWRITE $align_save "$Ax_dif = " + $Ax_dif
    FILEWRITE $align_save "$Ay_dif = " + $Ay_dif
    FILEWRITE $align_save "$zMeasureA = " + $zMeasureA
    FILEWRITE $align_save "$Az_dif = " + $Az_dif
ENDIF
IF $nozzle = 2
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_2.txt", 0
    FILEWRITE $align_save "$Bx_dif = " + $Bx_dif
    FILEWRITE $align_save "$By_dif = " + $By_dif
    FILEWRITE $align_save "$zMeasureB = " + $zMeasureB
    FILEWRITE $align_save "$Bz_dif = " + $Bz_dif
ENDIF
IF $nozzle = 3
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_3.txt", 0
    FILEWRITE $align_save "$Cx_dif = " + $Cx_dif
    FILEWRITE $align_save "$Cy_dif = " + $Cy_dif
    FILEWRITE $align_save "$zMeasureC = " + $zMeasureC
    FILEWRITE $align_save "$Cz_dif = " + $Cz_dif
ENDIF
IF $nozzle = 4
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_4.txt", 0
    FILEWRITE $align_save "$Dx_dif = " + $Dx_dif
    FILEWRITE $align_save "$Dy_dif = " + $Dy_dif
    FILEWRITE $align_save "$zMeasureD = " + $zMeasureD
    FILEWRITE $align_save "$Dz_dif = " + $Dz_dif
ENDIF


FILECLOSE $align_save
ENDDFS
